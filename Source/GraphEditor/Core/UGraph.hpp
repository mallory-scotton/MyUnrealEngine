///////////////////////////////////////////////////////////////////////////////
// Header guard
///////////////////////////////////////////////////////////////////////////////
#pragma once

///////////////////////////////////////////////////////////////////////////////
// Dependencies
///////////////////////////////////////////////////////////////////////////////
#include "Utils/Types.hpp"
#include "Utils/Archive/Archive.hpp"
#include "GraphEditor/Core/UNode.hpp"
#include "GraphEditor/Core/ULink.hpp"
#include "GraphEditor/Core/UPin.hpp"
#include "GraphEditor/Core/UEvaluationContext.hpp"

///////////////////////////////////////////////////////////////////////////////
// Namespace UEB
///////////////////////////////////////////////////////////////////////////////
namespace UEB
{

///////////////////////////////////////////////////////////////////////////////
/// \brief
///
///////////////////////////////////////////////////////////////////////////////
class UGraph
{
private:
    ///////////////////////////////////////////////////////////////////////////
    //
    ///////////////////////////////////////////////////////////////////////////
    TVector<TSharedPtr<UNode>> mNodes;  //<!
    TVector<TSharedPtr<ULink>> mLinks;  //<!
    bool mCreating;                     //<!
    FString mSearch;                    //<!
    bool mPopupOpened;                  //<!
    ImVec2 mPosition;                   //<!

public:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    UGraph(void);

private:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param id
    ///
    /// \return
    ///
    ///////////////////////////////////////////////////////////////////////////
    TSharedPtr<UPin> FindPin(UPin::ID id);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param node
    ///
    ///////////////////////////////////////////////////////////////////////////
    void AddNode(TSharedPtr<UNode> node);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param node
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveNode(TSharedPtr<UNode> node);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param id
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveNode(UNode::ID id);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param source
    /// \param target
    ///
    ///////////////////////////////////////////////////////////////////////////
    void SetLink(TSharedPtr<UPin> source, TSharedPtr<UPin> target);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param link
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveLink(TSharedPtr<ULink> link);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param id
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveLink(ULink::ID id);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void HandleCreate(void);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void HandleDelete(void);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RenderGraphEditor(void);

public:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void Render(void);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param archive
    ///
    ///////////////////////////////////////////////////////////////////////////
    void Serialize(UArchive& archive);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \tparam EventNodeType
    ///
    /// \param name
    ///
    /// \return
    ///
    ///////////////////////////////////////////////////////////////////////////
    template <typename EventNodeType>
    TSharedPtr<UNode> FindEventNode(const FString& name)
    {
        for (auto& node : mNodes) {
            auto eventNode = std::dynamic_pointer_cast<EventNodeType>(node);
            if (eventNode && eventNode->GetName() == name) {
                return (eventNode);
            }
        }

        return (nullptr);
    }

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param node
    /// \param context
    ///
    ///////////////////////////////////////////////////////////////////////////
    void Execute(TSharedPtr<UNode> node, UEvaluationContext& context);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \tparam EventNodeType
    ///
    /// \param context
    ///
    ///////////////////////////////////////////////////////////////////////////
    template <typename EventNodeType>
    void Execute(UEvaluationContext& context, float deltaSeconds = 0.f)
    {
        TSharedPtr<EventNodeType> eventNode = nullptr;

        for (auto& node : mNodes) {
            eventNode = std::dynamic_pointer_cast<EventNodeType>(node);
            if (eventNode) {
                break;
            }
        }

        if (!eventNode) {
            return;
        }

        if (eventNode->GetName() == "Event Tick") {
            context.SetPinValue<float>(eventNode->GetInputs()[0], deltaSeconds);
        }

        Execute(eventNode, context);
    }
};

} // !namespace UEB

///////////////////////////////////////////////////////////////////////////////
// Header guard
///////////////////////////////////////////////////////////////////////////////
#pragma once

///////////////////////////////////////////////////////////////////////////////
// Dependencies
///////////////////////////////////////////////////////////////////////////////
#include "Utils/Types.hpp"
#include "GraphEditor/UNode.hpp"
#include "GraphEditor/ULink.hpp"
#include "GraphEditor/UPin.hpp"
#include "GraphEditor/UEvaluationContext.hpp"

///////////////////////////////////////////////////////////////////////////////
// Namespace TKD
///////////////////////////////////////////////////////////////////////////////
namespace TKD
{

///////////////////////////////////////////////////////////////////////////////
/// \brief
///
///////////////////////////////////////////////////////////////////////////////
class UGraph
{
private:
    ///////////////////////////////////////////////////////////////////////////
    //
    ///////////////////////////////////////////////////////////////////////////
    TVector<TSharedPtr<UNode>> mNodes;  //<!
    TVector<TSharedPtr<ULink>> mLinks;  //<!
    bool mCreating;                     //<!
    FString mSearch;                    //<!
    bool mPopupOpened;                  //<!
    ImVec2 mPosition;                   //<!

public:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    UGraph(void);

private:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param id
    ///
    /// \return
    ///
    ///////////////////////////////////////////////////////////////////////////
    TSharedPtr<UPin> FindPin(UPin::ID id);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param node
    ///
    ///////////////////////////////////////////////////////////////////////////
    void AddNode(TSharedPtr<UNode> node);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param node
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveNode(TSharedPtr<UNode> node);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param id
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveNode(UNode::ID id);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param source
    /// \param target
    ///
    ///////////////////////////////////////////////////////////////////////////
    void SetLink(TSharedPtr<UPin> source, TSharedPtr<UPin> target);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param link
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveLink(TSharedPtr<ULink> link);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param id
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RemoveLink(ULink::ID id);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void HandleCreate(void);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void HandleDelete(void);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void RenderGraphEditor(void);

public:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void Render(void);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param context
    ///
    ///////////////////////////////////////////////////////////////////////////
    template <typename EventNodeType>
    void Execute(UEvaluationContext& context)
    {
        TSharedPtr<EventNodeType> eventNode = nullptr;

        for (auto& node : mNodes) {
            eventNode = std::dynamic_pointer_cast<EventNodeType>(node);
            if (eventNode) {
                break;
            }
        }

        if (!eventNode) {
            return;
        }

        context.AddToEvaluationQueue(eventNode);

        while (!context.IsQueueEmpty()) {
            auto node = context.GetNextNode().lock();

            if (!node) {
                continue;
            }

            if (!context.IsEvaluated(node)) {
                node->Evaluate(context);
                context.MarkAsEvaluated(node);
            }

            for (auto& pin : node->GetOutputs()) {
                if (
                    pin->GetType() != UPin::Type::Flow ||
                    context.GetPinValue<bool>(pin) == false
                ) {
                    continue;
                }

                for (auto& wlink : pin->GetLinks()) {
                    TSharedPtr<ULink> link = wlink.lock();
                    if (!link) {
                        continue;
                    }

                    TSharedPtr<UPin> target = link->GetTarget();

                    context.AddToEvaluationQueue(target->GetOwner());
                }
            }
        }
    }
};

} // !namespace TKD
